<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>他的国</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="他的国">
<meta property="og:url" content="https://dingmingk.github.io/page/3/index.html">
<meta property="og:site_name" content="他的国">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="他的国">
  
    <link rel="alternative" href="/atom.xml" title="他的国" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <script src="/style.js"></script>
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/assets/blogImg/dingmingk.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">dingmingk</a></h1>
		</hgroup>

		
		<p class="header-subtitle">做一个安静的美男子</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">标签</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">友链</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="3" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/dingmingk" title="github">github</a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/2704974481" title="weibo">weibo</a>
		        
					<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jin-ding-ming" title="zhihu">zhihu</a>
		        
					<a class="mail" target="_blank" href="/dingmingk@gmail.com" title="mail">mail</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">dingmingk</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="/assets/blogImg/dingmingk.jpg" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">dingmingk</h1>
			</hgroup>
			
			<p class="header-subtitle">做一个安静的美男子</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/dingmingk" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/2704974481" title="weibo">weibo</a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jin-ding-ming" title="zhihu">zhihu</a>
			        
						<a class="mail" target="_blank" href="/dingmingk@gmail.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        
  
    <article id="post-rabbitmq_cluster" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/01/rabbitmq_cluster/">RabbitMQ 集群</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="集群部署"><a href="#集群部署" class="headerlink" title="集群部署"></a>集群部署</h2><p>我们准备三台服务器配置集群，其中两台RabbitMQ为内存（RAM）节点，单台为磁盘节点。</p>
<p>集群节点配置 DNS 记录或 hosts。</p>
<p><strong>TODO</strong> </p>
<h4 id="启动集群节点"><a href="#启动集群节点" class="headerlink" title="启动集群节点"></a>启动集群节点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">rabbit1$ rabbitmq-server -detached</div><div class="line">rabbit2$ rabbitmq-server -detached</div><div class="line">rabbit3$ rabbitmq-server -detached</div></pre></td></tr></table></figure>
<h4 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">rabbit2$ rabbitmqctl stop_app</div><div class="line">rabbit2$ rabbitmqctl join_cluster --ram rabbit@rabbit1</div><div class="line">rabbit2$ rabbitmqctl start_app</div></pre></td></tr></table></figure>
<p><em>rabbit3 同上，也可以加入rabbit2</em></p>
<h4 id="分离集群"><a href="#分离集群" class="headerlink" title="分离集群"></a>分离集群</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">rabbit3$ rabbitmqctl stop_app</div><div class="line">rabbit3$ rabbitmqctl reset</div><div class="line"></div><div class="line">rabbit1$ rabbitmqctl forget_cluster_node rabbit@rabbit3</div></pre></td></tr></table></figure>
<h4 id="集群备注"><a href="#集群备注" class="headerlink" title="集群备注"></a>集群备注</h4><p><code>rabbitmqctl cluster_status</code> 查看集群状态</p>
<p><code>rabbitmqctl stop</code> 和 <code>rabbitmqctl stop_app</code> 的区别是后者只停止应用，前者还会停止节点。</p>
<p><code>rabbitmqctl change_cluster_node_type ram|disc</code> 可以更改节点类型（需要先停止应用）。</p>
<h2 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h2><p><strong>TODO</strong></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2016/03/01/rabbitmq_cluster/" class="archive-article-date">
  	<time datetime="2016-02-29T16:00:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-03-01</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RabbitMQ/">RabbitMQ</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-cgroup_part2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/29/cgroup_part2/">使用 Cgroup</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Cgconfig服务"><a href="#Cgconfig服务" class="headerlink" title="Cgconfig服务"></a>Cgconfig服务</h2><p>要使用 cgroup，首先要确认系统中已安装 <code>libcgroup</code>软件包。（RedHat系）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># yum install libcgroup</div></pre></td></tr></table></figure>
<h4 id="cgconfig-conf文件"><a href="#cgconfig-conf文件" class="headerlink" title="cgconfig.conf文件"></a>cgconfig.conf文件</h4><p>cgconfig.conf 文件包含两个主要类型的条目 ——— mount 和 group。挂载条目生成并挂载层级并将其作为虚拟文件系统，同时将子系统附加到那些层级中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># cat /etc/cgconfig.conf</div><div class="line"></div><div class="line">mount &#123;</div><div class="line">        cpuset  = /cgroup/cpuset;</div><div class="line">        cpu     = /cgroup/cpu;</div><div class="line">        cpuacct = /cgroup/cpuacct;</div><div class="line">        memory  = /cgroup/memory;</div><div class="line">        devices = /cgroup/devices;</div><div class="line">        freezer = /cgroup/freezer;</div><div class="line">        net_cls = /cgroup/net_cls;</div><div class="line">        blkio   = /cgroup/blkio;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>挂载子系统的备选方法是使用 shell 命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># mkdir /cgroup/cpu</div><div class="line"># mount -t cgroup -o cpu cpu /cgroup/cpu</div></pre></td></tr></table></figure>
<p>组群条目使用一下语法设定子系统参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">group &lt;name&gt;</div><div class="line">	[&lt;permissions&gt;]</div><div class="line">	&lt;controller&gt; &#123;</div><div class="line">		&lt;param name&gt; = &lt;param value&gt;;</div><div class="line">		...</div><div class="line">	&#125;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="e-g-为-sql-守护进程创建-cgroup，可为-sqladmin-组群中的用户在-cgroup-中添加任务，并让-root-用户修改子系统参数："><a href="#e-g-为-sql-守护进程创建-cgroup，可为-sqladmin-组群中的用户在-cgroup-中添加任务，并让-root-用户修改子系统参数：" class="headerlink" title="e.g. 为 sql 守护进程创建 cgroup，可为 sqladmin 组群中的用户在 cgroup 中添加任务，并让 root 用户修改子系统参数："></a>e.g. 为 sql 守护进程创建 cgroup，可为 sqladmin 组群中的用户在 cgroup 中添加任务，并让 root 用户修改子系统参数：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">group daemons/sql &#123;</div><div class="line">	perm &#123;</div><div class="line">		task &#123;</div><div class="line">			uid = root;</div><div class="line">			gid = sqladmin;</div><div class="line">		&#125; admin &#123;</div><div class="line">			uid = root;</div><div class="line">			gid =root;</div><div class="line">		&#125;</div><div class="line">	&#125; cpu &#123;</div><div class="line">		cpu.shares = 100;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上配置对等的 shell 命令为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># mkdir -p /cgroup/cpu/daemons/sql</div><div class="line"># chown root:root /cgroup/cpu/daemons/sql/*</div><div class="line"># chown root:sqladmin /cgfroup/cpu/daemons/sql/tasks</div><div class="line"># echo 100 &gt; /cgroup/cpu/daemons/sql/cpu.shares</div></pre></td></tr></table></figure>
<h2 id="在现有层级中附加或删除子系统"><a href="#在现有层级中附加或删除子系统" class="headerlink" title="在现有层级中附加或删除子系统"></a>在现有层级中附加或删除子系统</h2><p>要在现有层级中添加子系统，从现有层级中取消层级或者将其移动到不同的层级中，请作为 root 编辑 /etc/cgconfig.conf 文件的 mount 部分，当 cgconfig 下次重启时，它会根据您指定的层级识别那些子系统。</p>
<p>使用 mount 命令挂载时加上 remount 参数，并列出新的子系统列表即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># mount -t cgroup -o remount,cpu,cpuset,... cpu_and_mem</div></pre></td></tr></table></figure>
<h2 id="卸载层级"><a href="#卸载层级" class="headerlink" title="卸载层级"></a>卸载层级</h2><p>直接使用 umount 即可卸载层级。不过需要注意的是：如果该层级目前为空（即它只包含 root cgroup），则在卸载它时会取消激活该层级。如果该层级包含任意其他 cgroup，该层级在内核中仍保持活跃，即使不再挂载它也是如此。</p>
<p>要删除层级，请确定您在卸载该层级前删除所有子 cgroup，或者使用 cgclear命令，它可在层级非空时也可取消激活层级。</p>
<h2 id="cgroup操作"><a href="#cgroup操作" class="headerlink" title="cgroup操作"></a>cgroup操作</h2><h4 id="cgcreate"><a href="#cgcreate" class="headerlink" title="cgcreate"></a>cgcreate</h4><blockquote>
<p>语法： cgcreate -t uid:gid -a uid:gid -g subsystems:path</p>
</blockquote>
<ul>
<li>-t（可选）：指定用户（使用用户 ID，uid）和组群（使用组群 ID，gid）以便让这个 cgroup 拥有 tasks 伪文件。这个用户可在该 cgroup 中添加任务。</li>
<li>-a（可选）：指定用户（使用用户ID，uid）和组群（使用组群ID，gid）以便这个 cgroup 拥有 tasks 外的所有伪文件。这个用户可修改这个 cgroup 中的任务对系统资源的访问。</li>
<li>-g：指定在其中创建 cgroup 的层级，格式为与那些层级关联的用逗号分开的 subsystems 列表。如果这个列表中的子系统在不同的层级中，则要在每个层级中都创建该组群。层级列表后是一个冒号，然后是与该层级有关的子组群 path。不要在该 path 中包含层级挂载点。</li>
</ul>
<p><em>e.g.</em> 在 cpu_and_mem 层级中一同挂载 cpu 和 memory 子系统的系统，并将 net_cls 控制器挂载到名为 net 的另一个层级中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># cgcreate -g cpu,net_cls:/test-subgroup</div></pre></td></tr></table></figure>
<p><em>备用方法</em>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># mkdir /cgroup/hierarchy/name/child_name</div></pre></td></tr></table></figure>
<h4 id="cgdelete"><a href="#cgdelete" class="headerlink" title="cgdelete"></a>cgdelete</h4><p>使用 cgdelete 删除 cgroup，其语法与 cgcreate 类似。</p>
<blockquote>
<p>cgdelete subsystems:path</p>
<p>-r 递归删除所有子组群</p>
</blockquote>
<p><em>e.g.</em> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># cgdelete cpu,net_cls:/test-subgroup</div></pre></td></tr></table></figure>
<h4 id="cgset"><a href="#cgset" class="headerlink" title="cgset"></a>cgset</h4><p>在可修改相关的 cgroup 的用户账户中 运行 cgset 命令设置子系统参数。</p>
<blockquote>
<p>cgset -r parameter=value path_to_cgroup</p>
<p>parameter： 是要设定的参数，该参数与给定 cgroup 的目录中的文件对应。</p>
<p>value： 是为参数设定的值</p>
<p>path_to_cgroup： 是到相对该层级 root 的 cgroup 路径。</p>
<p>–copy-from path_to_source_cgroup path_to_target_cgroup： 将一个 cgroup 中的参数复制到另一个现有 cgroup 中。</p>
</blockquote>
<p><em>备用方法</em></p>
<p>要直接在 cgroup 中设置参数，可使用 echo 命令将值插入相关子系统伪文件中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># echo 0-1 &gt; /cgroup/cpuset/group1/cpuset.cpus</div></pre></td></tr></table></figure>
<h2 id="cgclassify"><a href="#cgclassify" class="headerlink" title="cgclassify"></a>cgclassify</h2><blockquote>
<p>cgclassify -g subsystems:path_to_cgroup pidlist</p>
<p>subsystems： 是用逗号分开的子系统列表，或者 ＊ 启动与所有可用子系统关联的层级中的进程。</p>
<p>path_to_cgroup： 是到其层级中的 cgroup 的路径。</p>
<p>pidlist： 是用空格分开的进程识别符（PID）列表。 </p>
</blockquote>
<p><em>e.g.</em> 将 PID 为 1701 和 1138 的进程移动到 cgorup 中的 group1/：<code># cgclassify -g cpu,memory:group1 1701 1138</code></p>
<p><em>备用方法</em></p>
<p><code># echo 1701 &gt; /cgroup/lab1/group/tasks</code></p>
<h2 id="cgred"><a href="#cgred" class="headerlink" title="cgred"></a>cgred</h2><p>Cgred 是一个守护进程，它可根据在 <code>/etc/cgrules.conf</code> 中设定的参数将任务移动到 cgroup 中，条目可以使用以下两种格式之一：</p>
<ul>
<li>user hierarchies control_group</li>
<li>user:command hierarchies control_group</li>
</ul>
<p><em>e.g.</em> </p>
<p><code>maria        devices        /usergroup/staff</code></p>
<p>这个条目指定任何属于名为 maria 用户的进程根据在 /usergroup/staff cgroup 中指定的参数访问设备子系统。</p>
<p><code>maria:ftp    devices    /usergroup/staff/ftp</code></p>
<p>该条目现在指定核实名为 maria 的用户使用 ftp 命令 ，自动将该进程移动到包含 devices 子系统的层级中的 /usergroup/staff/ftp cgroup 中。</p>
<h4 id="etc-cgrules-conf"><a href="#etc-cgrules-conf" class="headerlink" title="/etc/cgrules.conf"></a>/etc/cgrules.conf</h4><blockquote>
<p>@：当在 user 使用前缀时，代表是一个组群而不是一个单独用户。例如： @admins 是 admins 组群中的所有用户。</p>
<p>*： 代表“所有”。</p>
<p>%： 代表与以上行中项目相同的项目。</p>
</blockquote>
<h2 id="cgexec"><a href="#cgexec" class="headerlink" title="cgexec"></a>cgexec</h2><blockquote>
<p>cgexec -g subsystems:path_to_cgroup command arguments</p>
<p>subsystems：是用逗号分开的子系统列表或者 * 启动与所有可用子系统关联的层级的进程。</p>
<p>path_to_cgroup：是到与该层级相关的 cgroup 的路径。</p>
<p>commond：是要运行的命令。</p>
<p>arguments：是该命令所有参数。</p>
<p>–sticky：将所有子进程放在同一 cgroup 中。</p>
</blockquote>
<p><em>备用方法</em></p>
<p><code># echo $$ &gt; /cgroup/lab1/group1/tasks</code></p>
<p>请注意：**退出用户后，现有 shell 中仍在 group1 cgroup 中。因此更好的方法应为：</p>
<p><code># sh -c &quot;echo \$$ &gt; /cgroup/lab1/group1/tasks &amp;&amp; USER</code></p>
<h4 id="在控制组群中启动服务"><a href="#在控制组群中启动服务" class="headerlink" title="在控制组群中启动服务"></a>在控制组群中启动服务</h4><p>您可在某个 cgroup 中启动某些服务。在 cgroup 中启动的服务必须：</p>
<ul>
<li>使用 /etc/sysconfig/servicename 文件</li>
<li>使用 /etc/init.d/functions 的 daemon()功能启动该服务</li>
</ul>
<p>要在某个 cgroup 中启动合格服务，请在 /etc/sysconfig 中编辑其文件，使该文件包含如下条目：<strong>CGROUP_DAEMON=”subsystem:control_group”</strong></p>
<p><em>e.g.</em> <code>CGROUP_DAEMON=&quot;cpuset:daemons/sql&quot;</code></p>
<h2 id="获得有关控制组群的信息"><a href="#获得有关控制组群的信息" class="headerlink" title="获得有关控制组群的信息"></a>获得有关控制组群的信息</h2><h4 id="查找某个进程"><a href="#查找某个进程" class="headerlink" title="查找某个进程"></a>查找某个进程</h4><p><code>$ ps -O cgroup</code></p>
<p><code>$ cat /proc/PID/cgroup</code></p>
<h4 id="查找子系统"><a href="#查找子系统" class="headerlink" title="查找子系统"></a>查找子系统</h4><p><code>$ cat /proc/cgroups</code></p>
<p><code>$ lssubsys -m subsystems</code></p>
<h4 id="查找层级"><a href="#查找层级" class="headerlink" title="查找层级"></a>查找层级</h4><p><code>$ tree /cgroup/</code></p>
<h4 id="查找控制组群"><a href="#查找控制组群" class="headerlink" title="查找控制组群"></a>查找控制组群</h4><p><code>$ lscgroup</code></p>
<p><code>$ lscgroup cpuset:adminusers</code></p>
<h4 id="显示控制组群的参数"><a href="#显示控制组群的参数" class="headerlink" title="显示控制组群的参数"></a>显示控制组群的参数</h4><p><code>$ cgget -r parameter list_of_cgroups</code></p>
<p>其中 parameter 是包含子系统值的伪文件，list_of_cgroups 是用空格分开的 cgorup 列表。</p>
<h2 id="cgclear"><a href="#cgclear" class="headerlink" title="cgclear"></a>cgclear</h2><p><strong>cgclear 命令将破坏所有层级中的所有 cgroup。如果没有在配置文件中保存这些层级，将无法再次构建它们。</strong></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2016/02/29/cgroup_part2/" class="archive-article-date">
  	<time datetime="2016-02-28T16:00:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-02-29</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cgroup/">Cgroup</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-systemd_part1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/27/systemd_part1/">Systemd 的服务管理模型</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Systemd 是 CoreOS 采用的服务进程和系统资源管理工具。它最初的设计目标主要是克服传统 Linux 主流启动程序 SysV-init 的固有设计缺陷，提高系统的启动速度。 Systemd 的设计思路借鉴了 Mac OSX 系统的启动程序 Launchd，相比其他的 SysV-init 替代方案，例如 Ubuntu 的 Upstart，Systemd 的设计更加前卫。</p>
<p>事实上，Systemd 是一系列系统工具的集合，其作用也远远不仅是启动操作系统，它还接管了后台服务启动、结束、状态查询，以及日志归档、设备管理、电源管理、定时任务等许多指责，并支持通过特定事件（如插入特定 USB 设备）和特定端口数据触发的 On-demand 任务。在 CoreOS 的世界里，几乎所有与应用程序打交道的工作，都会交由 Systemd 进行管理，包括运行在容器中的服务。</p>
<h2 id="Systemd的设计理念"><a href="#Systemd的设计理念" class="headerlink" title="Systemd的设计理念"></a>Systemd的设计理念</h2><ul>
<li>尽可能启动更少的进程</li>
<li>尽可能将更多的进程并行启动</li>
<li>采用 CGroup 跟踪和管理进程的生命周期</li>
<li>统一管理服务日志</li>
</ul>
<h2 id="Systemd的服务管理"><a href="#Systemd的服务管理" class="headerlink" title="Systemd的服务管理"></a>Systemd的服务管理</h2><h4 id="Unit"><a href="#Unit" class="headerlink" title="Unit"></a>Unit</h4><p>Unit 是 Systemd 管理服务的基本单元，可以认为每个服务就是一个 Unit，并使用一个 Unit 文件定义。在 Unit 文件中需要包含相应服务的描述、属性以及需要运行的命令。</p>
<p>在 CoreOS 中运行服务的命令通常是一系列的容器操作，而将具体的服务进程封装在容器中。</p>
<h4 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h4><p>Target 是 Systemd 中用于指定服务启动组的方式，相当于 SysV-init 中的“运行级别”。每次系统启动时都会运行与当前系统具有相同级别 Target 关联的所有服务，如果服务不需要跟随系统自动启动，则完全可以忽略这个 Target 的内容。</p>
<p>通常来说，大多数 Linux 用户平时使用的都是“多用户模式”这个级别，对应的 Target 值为 “multi-user.target”，它有一个等效的可用值是“default.target”。</p>
<h2 id="Hello-Systemd"><a href="#Hello-Systemd" class="headerlink" title="Hello Systemd"></a>Hello Systemd</h2><p>在 CoreOS 中，用户的自定义服务配置文件通常放在 <code>/etc/systemd/system</code>目录中。进入这个目录，新建一个名为“hello.service”的文件，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[Unit］</div><div class="line">Description=Hello Systemd</div><div class="line">After=docker.service</div><div class="line">Requires=docker.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">TimeoutStartSec=0</div><div class="line">ExecStartPre=-/usr/bin/docker kill busybox1</div><div class="line">ExecStartPre=-/usr/bin/docker rm busybox1</div><div class="line">ExecStartPre=/usr/bin/docker pull busybox</div><div class="line">ExecStart=/usr/bin/docker run --name busybox1 busybox /bin/sh -c &quot;while true; do echo Hello Systemd; sleep 1; done&quot;</div><div class="line">ExecStop=/usr/bin/docker stop busybox1</div><div class="line">ExecStopPost=/usr/bin/docker rm busybox1</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure>
<p>这里需要注意两个地方：</p>
<ol>
<li>ExecStart 属性只能包含一条主要命令，而在这个属性的前后可以分别使用 ExecStartPre 和 ExecStartPost 指定更多的辅助命令；ExecStop同理。</li>
<li>有些辅助命令会加上一个减号（-），表示忽略这些命令的出错。</li>
</ol>
<h2 id="日志管理"><a href="#日志管理" class="headerlink" title="日志管理"></a>日志管理</h2><p>Systemd 通过其标准日志服务 Journald 将其管理的所有后台进程打印到 std:out（即控制台）的输出重定向到了日志文件。</p>
<p>日志文件是二进制格式的，必须使用 Journald 提供的配套程序 journalctl 来查看。 </p>
<h4 id="Journalctl"><a href="#Journalctl" class="headerlink" title="Journalctl"></a>Journalctl</h4><p>Journalctl 的使用非常简单，默认不带任何参数时会输出系统和所有后台进程的混合日志，可以通过一些参数选择性地过滤所需的内容。</p>
<ul>
<li>–dmesg：内核输出的日志</li>
<li>–system：各类系统服务的控制台输出</li>
<li>–unit xxx.service：用户指定的服务日志</li>
</ul>
<p>高级用法：</p>
<ul>
<li>–follow：实时跟踪日志输出</li>
<li>–since和–unit：指定显示的日志时间区间（e.g. –since “2015-07-20 12:00:00” –until “2015-07-20 12:30:00”）,–since=today可以直接打印当天输出的日志。</li>
<li>–reverse：反向输出日志</li>
<li>–lines：查看最新的N行日志（e.g. –lines n）</li>
<li>–output：改变输出日志的格式（e.g. –output json-pretty）</li>
</ul>
<p>另外，除了使用 –unit 参数指定 Unit 名称外，还可以指定程序名称和指定进程 PID。</p>
<ul>
<li>$ journalctl /usr/lib/systemd/systemd </li>
<li>$ journalctl _PID=1</li>
</ul>
<h4 id="日志大小限制"><a href="#日志大小限制" class="headerlink" title="日志大小限制"></a>日志大小限制</h4><p>默认日志最大限制为所在文件系统容量的 10％。即：如果<code>/var/log/journal</code>存储在 50GB 的根分区中，那么日志最多存储 5GB 数据。</p>
<p>可以通过修改 <code>/etc/systemd/journald.conf</code>中的 <code>SystemMaxUse</code>来指定该最大限制。比如<code>SystemMaxUse=50M</code>。</p>
<h2 id="服务的生命周期"><a href="#服务的生命周期" class="headerlink" title="服务的生命周期"></a>服务的生命周期</h2><ol>
<li>当一个新的 Unit 文件被放入 <code>/etc/systemd/system/</code>或<code>/usr/lib/systemd/system/</code>目录中时，它是不会被 Systemd 识别到的；（$ systemctl list-unit-files）</li>
<li>systemctl start|enable 激活；($ systemctl list-units <unit>)</unit></li>
<li>使用 systemctl start 命令可以启动指定的服务，启动时会一次执行定义在 Unit 文件中的 ExecStartPre、ExecStart、ExecStartPost命令</li>
<li>使用 ststmectl stop 命令可以结束指定的服务，结束时会依次执行定义在 Unit 文件中的 ExecStopPre、ExecStop、ExecStopPost命令；</li>
<li>systemctl restart 命令相当于先结束指定的服务，然后立即重新启动它；</li>
<li>systemctl kill命令会立即杀死服务，而不会执行 Unit 中指定的结束命令；</li>
<li>systemctl enable xxx.service 设置开机启动；</li>
<li>systmectl disable xxx.service 取消开机启动；</li>
<li>systemctl daemon-reload 重新加载 Unit 文件；</li>
<li>systemctl reset-failed 移除已经被标记为丢失的 Unit 文件。</li>
</ol>
<h2 id="服务的Unit文件"><a href="#服务的Unit文件" class="headerlink" title="服务的Unit文件"></a>服务的Unit文件</h2><p>服务的 Unit 文件可以分为三个配置区段，其中 Unit 段和 Install 段是所有 Unit 文件通用的，用于配置服务（或其他系统资源）的描述、依赖和随系统启动方式，而 Service 段则是服务类型的 Unit 文件（后缀为.service）特有的，用于定义服务的具体管理和操作方法。</p>
<h4 id="配置区段的常用参数"><a href="#配置区段的常用参数" class="headerlink" title="配置区段的常用参数"></a>配置区段的常用参数</h4><ul>
<li>Unit <ul>
<li>Description: 一段描述这个 Unit 文件的文字。</li>
<li>Documentation: 指定服务的文档，可以是一个或多个文档的路径。</li>
<li>Requires: 依赖的其他 Unit 列表，依赖服务启动失败会导致这个服务被终止。</li>
<li>Wants: 与 Requires 相似，但不考虑依赖服务是否启动成功。</li>
<li>After: 与 Requires 相似，但是在列出的服务都启动完成后才会启动当前服务。</li>
<li>Before: 与 After 相反。</li>
<li>BindsTo: 与 Requires 相似，但是关联性更强。</li>
<li>Part Of: 这是一个 BindTo 作用的子集，仅在列出的任何模块失败或重启时，终止或重启当前服务，而不会随列出的模块的启动而启动。</li>
<li>OnFailure: 当这个模块启动失败时，就会自动启动列出的每个模块。</li>
<li>Conflicts: 与这个模块有冲突的模块，如果列出的模块中有已经在运行的，这个服务就不能启动；反之亦然。</li>
</ul>
</li>
<li>Install <ul>
<li>WantedBy: 和前面的 Wants 相似，只是后面列出的不是服务所依赖的模块，而是依赖当前服务的模块。</li>
<li>RequiredBy: 和前面的 Requires 相似，只是后面列出的不是服务所依赖的模块，而是依赖当前服务的模块。</li>
<li>Also: 当这个服务被 enable/disable 时，将自动 enable/disable 后面列出的每个模块。</li>
</ul>
</li>
<li>Service<ul>
<li>Type: 服务的类型，常用的有 simple 和 forking。</li>
<li>RemainAfterExix: 值为 true 或 false（也可以写为 yes 或 no），默认为 false。当配置值为 true 时，Systemd 只会负责启动服务进程，之后即便服务进程退出了，Systemd也仍然会认为这个服务还在运行中。这个配置主要是提供给一些并非常驻内存，而是启动注册后立即退出，燃火等待消息按需启动的特许类型服务使用的。</li>
<li>ExecStart: 这个参数是疾呼每个”.service”文件都会有的，指定服务启动的主要命令，在每个配置文件中只能使用一次。</li>
<li>ExecStartPre: 指定在启动执行 ExecStart 命令前的准备工作，在同一个配置文件中可以有多个。</li>
<li>ExecStartPost: 指定在启动执行 ExecStart 命令后的首位工作，在同一个配置文件中可以有多个。</li>
<li>TimeoutStartSec: 启动服务时的超时时间。Docker 第一次运行时可能会需要从网络上下载服务的镜像文件，因此造成比较严重的延时，建议将值指定为 0，从而关闭检测。</li>
<li>ExecStop: 停止服务所需要执行的主要命令，在每个配置文件中只能有一个。</li>
<li>ExecStopPost: 指定在 ExecStop 命令执行后的收尾工作，在同一个配置文件中可以有多个。</li>
<li>TimeoutStopSec: 停止服务时的超时时间。</li>
<li>Restart: 这个值用语指定在什么情况下需要重启服务进程。常用的值有 no、on-success、on-failure、on-abnormal、on-abort 和 always。默认值为 no。如下表格表示分别在哪些情况下，服务会被重新启动。</li>
<li>RestartSec: 如果服务需要被重启，这个参数的值为服务被重启前的等待秒数。</li>
<li>ExecReload: 重新加载服务所需执行的主要命令。</li>
<li>Environment: 为服务添加环境变量。</li>
<li>EnviromentFile: 指定加载一个包含服务所需的环境变量列表的文件，文件中的每一行都是一个环境变量的定义。</li>
<li>Nice: 服务的进程优先级，值越小优先级越高，默认为0。其中-20 为最高优先级，19为最低优先级。</li>
<li>WorkingDirectory: 指定服务的工作目录。</li>
<li>RootDirectory: 指定服务进程的根目录。如果配置了这个参数，服务将无法访问指定目录以外的任何文件。</li>
<li>User: 指定运行服务的用户，会影响服务对本地文件系统的访问权限。</li>
<li>Group: 指定运行服务的用户组，会影响服务对本地文件系统的访问权限。</li>
<li>MountFlags: 之歌值其实是服务的 Mount Namespace 的配置，会影响服务进程上下文中挂载点的信息，即服务是否会继承主机上已有的挂载点，以及如果服务运行时执行了挂载或卸载设备的操作，是否会真实地在主机上产生效果。可选值是 shared、slava 或 private。</li>
<li>LimitCPU／LimitSTACK／LimitNOFILE／LimitNPROC 等，限制特定服务可用的系统资源量。</li>
</ul>
</li>
</ul>
<h4 id="Systemd-中用于兼容-SysV-init-运行级别的目标-Unit-文件"><a href="#Systemd-中用于兼容-SysV-init-运行级别的目标-Unit-文件" class="headerlink" title="Systemd 中用于兼容 SysV-init 运行级别的目标 Unit 文件"></a>Systemd 中用于兼容 SysV-init 运行级别的目标 Unit 文件</h4><table>
<thead>
<tr>
<th style="text-align:left">SysV-init 运行级别</th>
<th style="text-align:center">Systemd 运行目标</th>
<th style="text-align:center">注释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">0</td>
<td style="text-align:center">runlevel0.target, poweroff.target</td>
<td style="text-align:center">关闭系统</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:center">runlevel1.target, rescue.target</td>
<td style="text-align:center">单用户模式</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:center">runlevel2.target, multi-user.target</td>
<td style="text-align:center">用于定义／域特定运行级别。默认等同于级别 3</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:center">runlevel3.target, multi-user.target</td>
<td style="text-align:center">多用户，无图形界面，用户可以通过终端或网络登录</td>
</tr>
<tr>
<td style="text-align:left">4</td>
<td style="text-align:center">runlevel4.target, multi-user.target</td>
<td style="text-align:center">用于定义／域特定运行级别。默认等同于级别 3</td>
</tr>
<tr>
<td style="text-align:left">5</td>
<td style="text-align:center">runlevel5.target, graphical.target</td>
<td style="text-align:center">多用户，图形界面，通常为所有运行级别 3 的服务并启动图形界面服务</td>
</tr>
<tr>
<td style="text-align:left">6</td>
<td style="text-align:center">runlevel6.target, reboot.target</td>
<td style="text-align:center">重启</td>
</tr>
<tr>
<td style="text-align:left">emergency</td>
<td style="text-align:center">emergency.target</td>
<td style="text-align:center">急救模式（Emergency shell）</td>
</tr>
</tbody>
</table>
<h4 id="Service-段的-Restart-属性"><a href="#Service-段的-Restart-属性" class="headerlink" title="Service 段的 Restart 属性"></a>Service 段的 Restart 属性</h4><table>
<thead>
<tr>
<th style="text-align:left">服务退出原因</th>
<th style="text-align:center">no</th>
<th style="text-align:center">always</th>
<th style="text-align:center">on-failure</th>
<th style="text-align:center">on-abnormal</th>
<th style="text-align:center">on-abort</th>
<th style="text-align:center">on-success</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">正常退出</td>
<td style="text-align:center"></td>
<td style="text-align:center">√</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">√</td>
</tr>
<tr>
<td style="text-align:left">异常退出</td>
<td style="text-align:center"></td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">启动／停止超时</td>
<td style="text-align:center"></td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:left">被异常杀死</td>
<td style="text-align:center"></td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
</tr>
</tbody>
</table>
<h2 id="Unit-文件占位符"><a href="#Unit-文件占位符" class="headerlink" title="Unit 文件占位符"></a>Unit 文件占位符</h2><p>在 Unit 文件中，有时会需要使用到一些与运行环境有关的信息，例如节点 ID、运行服务的用户等。这些信息可以使用占位符来表示，然后在实际运行时被动态地替换为实际的值。</p>
<table>
<thead>
<tr>
<th style="text-align:left">占位符</th>
<th style="text-align:center">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">%n</td>
<td style="text-align:center">完整的 Unit 文件名，包括 .service  后缀名</td>
</tr>
<tr>
<td style="text-align:left">%p</td>
<td style="text-align:center">Unit 模版文件名中在 @ 符号之前的部分，不包括 @ 符号</td>
</tr>
<tr>
<td style="text-align:left">%i</td>
<td style="text-align:center">Unit 模版文件名中在 @ 符号之后的部分，不包括 @ 符号和 .service 后缀名</td>
</tr>
<tr>
<td style="text-align:left">%t</td>
<td style="text-align:center">存放系统运行时文件的目录，通常都是 “/run”</td>
</tr>
<tr>
<td style="text-align:left">%u</td>
<td style="text-align:center">运行服务的用户们，如果 Unit 文件中没有指定，则默认为 root</td>
</tr>
<tr>
<td style="text-align:left">%U</td>
<td style="text-align:center">运行服务的用户 ID</td>
</tr>
<tr>
<td style="text-align:left">%h</td>
<td style="text-align:center">运行服务的用户 Home 目录，即 ${HOME} 环境变量的值</td>
</tr>
<tr>
<td style="text-align:left">%s</td>
<td style="text-align:center">运行服务的用户默认 Shell 类型，即 ${SHELL} 环境变量</td>
</tr>
<tr>
<td style="text-align:left">%m</td>
<td style="text-align:center">实际运行的节点的 Machine ID，对于运行位置敏感的服务比较有用</td>
</tr>
<tr>
<td style="text-align:left">%b</td>
<td style="text-align:center">Boot ID，这是一个随机数值，每个节点各不相同，并且每次节点重启时都会改变</td>
</tr>
<tr>
<td style="text-align:left">%H</td>
<td style="text-align:center">实际运行节点的主机名</td>
</tr>
<tr>
<td style="text-align:left">%v</td>
<td style="text-align:center">内核版本，即 “uname -r”命令输出的内容</td>
</tr>
<tr>
<td style="text-align:left">%%</td>
<td style="text-align:center">在 Unit 模版文件中表示一个普通的百分号</td>
</tr>
</tbody>
</table>
<h2 id="Unit-模版"><a href="#Unit-模版" class="headerlink" title="Unit 模版"></a>Unit 模版</h2><p>在现实中国年，往往有一些应用需要被复制多份运行，Systemd 定义了一种特殊的服务 Unit 文件，称之为 “Unit 模版”。</p>
<p>Unit 模版文件的写法与普通的服务 Unit 文件几本相同，不过 Unit 模版的文件名是以 @ 符号结尾的。通过模版启动服务实例时，需要在其文件名的 @ 字符后面添加一个参数字符串。</p>
<h4 id="apache-service"><a href="#apache-service" class="headerlink" title="apache@.service"></a>apache@.service</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=My Advanced Service Template</div><div class="line">After=etcd.service docker.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">TimeoutStartSec=0</div><div class="line">ExecStartpre=-/usr/bin/docker kill apache%i</div><div class="line">ExecStartPre=-/usr/bin/docker rm apache%i</div><div class="line">ExecStart=/usr/bin/docker run --name apache%i -p %i:80 coreos/apache /usr/sbin/apache2ctl -D FOREGROUND</div><div class="line">ExecStartPost=/usr/bin/etcdctl set /domains/example.com/%H:%i running</div><div class="line">ExecStop=/usr/bin/docker stop apache1</div><div class="line">ExecStopPost=/usr/bin/docker rm apache1</div><div class="line">ExecStopPost=/usr/bin/etcdctl rm /domains/example.com/%H:%i</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure>
<p>模版服务的启动也与普通的托管于 Systemd 的服务大致相同。</p>
<p><code>$ sudo systemctl start apache@8080.service</code></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2016/02/27/systemd_part1/" class="archive-article-date">
  	<time datetime="2016-02-26T16:00:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-02-27</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Systemd/">Systemd</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-cgroup_part1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/25/cgroup_part1/">Cgroup 简介</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>Cgroup</code>是<code>control group</code>的缩写，是Linux内核提供的一种可以限制、记录、隔离进程组（process group）所使用的物理资源（如：cpu，memory，IO等等）。</p>
<p>使用 cgroup，系统管理员可耕具体地控制对系统资源的分配、优先顺序、拒绝、管理和监控。可更好地根据任务和拥护分配硬件资源，提高总体效率。</p>
<p>Cgroup 最初由google的工程师提出，后来被整合进Linux内核。Cgroup 也是LXC（Linux container）为实现虚拟化所使用的资源管理工具。最初的 Docker 版本其实就是在LXC上集成一些工具集，后来才重新设计自己的虚拟化层，发布了<code>libcontainer</code>。</p>
<h2 id="如何管理cgroup"><a href="#如何管理cgroup" class="headerlink" title="如何管理cgroup"></a>如何管理cgroup</h2><p>Cgroup 是分层管理的，类似进程，且子 cgroup 会继承其上级 cgroup 的一些属性。但这两个模式也有不同。</p>
<h4 id="Linux-进程模式"><a href="#Linux-进程模式" class="headerlink" title="Linux 进程模式"></a>Linux 进程模式</h4><p>Linux 系统中的所有进程都是通用父进程 <code>init</code> 的子进程 ，该进程在引导时由内核执行并启动其它进程（这些进程会按顺序启动其子进程）。因为所有进程都归结到一个父进程，所以 Linux 进程模式是一个单一层级结构，或者树结构。</p>
<p>另外，init 之外的每个 Linux 进程都会继承其父进程的环境（比如 PATH 变量）和某些属性（比如打开文件描述符）。</p>
<h4 id="Cgroup-模式"><a href="#Cgroup-模式" class="headerlink" title="Cgroup 模式"></a>Cgroup 模式</h4><p>Cgroup 与进程在以下方面类似：</p>
<ul>
<li>它们是分级的</li>
<li>子 cgroup 会集成其 cgroup 的某些属性</li>
</ul>
<p>根本的不同是在某个系统中可同时存在不同的分级 cgroup。如果 Linux 进程模式是进程的单一树模式，那么 cgroup 模式是一个或者更多任务的独立、未连接树（例如：进程）。</p>
<p>需要多个独立 cgroup 分级，因为每个分级都会附加到一个或者多个子系统中。</p>
<h4 id="子系统"><a href="#子系统" class="headerlink" title="子系统"></a>子系统</h4><p>以 RedHat6 为例，系统提供9个 cgroup 子系统，根据名称和功能列出如下。</p>
<ul>
<li>blkio: 这个子系统为块设备设定输入／输出限制，比如物理设备（磁盘，固态硬盘，USB等等）。</li>
<li>cpu: 这个子系统使用调度程序提供对 CPU 的 cgroup 任务访问。</li>
<li>cpuacct: 这个子系统自动生成 cgroup 中任务所使用的 CPU 报告。 </li>
<li>cpuset: 这个子系统为 cgroup 中的任务分配独立 CPU（在多核系统）和内存节点。</li>
<li>devices: 这个子系统可允许或者拒绝 cgroup 中的任务访问设备。</li>
<li>freezer: 这个子系统挂起或者恢复 cgroup 中的任务。</li>
<li>memory: 这个子系统设定 cgroup 中任务使用的内存限制，并自动生成由那些任务使用的内存资源报告。</li>
<li>net_cls: 这个子系统使用等级识别符（classid）标记网络数据包，可允许 Linux 流量控制程序（tc）识别从具体 cgroup 中生成的数据包。</li>
<li>ns: 命名空间子系统。</li>
</ul>
<h2 id="子系统、层级、控制组群和任务的关系"><a href="#子系统、层级、控制组群和任务的关系" class="headerlink" title="子系统、层级、控制组群和任务的关系"></a>子系统、层级、控制组群和任务的关系</h2><blockquote>
<p>在 cgroup 术语中系统进程称为任务。</p>
</blockquote>
<h4 id="Rule-1"><a href="#Rule-1" class="headerlink" title="Rule 1"></a>Rule 1</h4><p><strong>任何单一子系统（比如 cpu）最多可附加到一个层级中。</strong></p>
<p><em>结果是，cpu 子系统永远无法附加到两个不同的层级。</em></p>
<h4 id="Rule-2"><a href="#Rule-2" class="headerlink" title="Rule 2"></a>Rule 2</h4><p><strong>单一层级可附加一个或者多个子系统</strong></p>
<p><em>结果是，cpu 和 memory 子系统（或者任意数目的子系统）都可附加到单一层级中，只要每个子系统不再附加到另一个层级即可。</em></p>
<h4 id="Rule-3"><a href="#Rule-3" class="headerlink" title="Rule 3"></a>Rule 3</h4><p>每次在系统中创建新层级时，该系统中的所有任务都是那个层级的默认 cgroup（我们称之为 root cgroup）的初始成员。任何创建的单一层级，该系统中的每个任务都可以是那个层级中唯一一个 cgroup 的成员。单一任务可以是在多个 cgroup 中，只要每个 cgroup 都在不同的层级中即可。只要某个任务成为同一层级中第二个 cgroup 成员，就会将其从那个层级的第一个 cgroup 中删除。</p>
<p><strong>一个任务永远不会同时位于同一层级的不同 cgroup 中。</strong></p>
<p><em>结果是，如果 cpu 和 memory 子系统都附加到名为 cpu_and_mem的层级中，且 net_cls 子系统是附加到名为 net 的层级中，那么运行的 httpd 进程可以是 cpu_and_mem 中任意 cgroup 的成员，同时也是 net 中任意 cgroup 的成员。</em></p>
<p>httpd 进程所在 cpu_and_mem 中的 cgroup 可将其 CPU 时间限制为分配给其它进程时间的一半，并将其内存用量限制为最多 1024MB。另外，net中的 cgroup 还可将其传输速率限制为 30MB／s。</p>
<p><strong>首次创建层级时，该系统中的每个任务都至少是一个 cgroup 的成员，即 root cgroup。因此每当使用 cgroup 时，每个系统任务总是至少在一个 cgroup 中。</strong></p>
<h4 id="Rule-4"><a href="#Rule-4" class="headerlink" title="Rule 4"></a>Rule 4</h4><p><strong>系统中的任意进程（任务）都将自己分支创建子进程（任务）。该子任务自动成为其父进程所在 cgroup 的成员。</strong>然后可根据需要将该子任务移动到不同的 cgroup 中，但开始时它总是继承其父任务的 cgroup（进程术语中称其为“环境”）。</p>
<p><em>cpu_and_mem 层级中名为 halt_cpu_1gb_max 的 cgroup 成员的任务，以及 net 层级中 cgroup trans_rate_30 的成员。当 httpd 进程将其自身分为几个分支时，其子进程会自动成为 half_cpu_1gb_max cgroup 和 trans_rate_30 cgroup 的成员。它会完全继承其父任务所属的同一 cgroup。</em></p>
<p>此后，父任务和子任务就彼此完全独立：更改某个任务所属 cgroup 不会影响到另一个。同样更改父任务的 cgroup 也不会以任何方式影响其子任务。<strong>总之：所有子任务总是可继承其父任务的同一 cgroup 的成员关系，但之后可更改或者删除那些成员关系。</strong></p>
<h2 id="资源管理实施"><a href="#资源管理实施" class="headerlink" title="资源管理实施"></a>资源管理实施</h2><ul>
<li>因为某个任务可属于任一层级中的单一 cgroup，所以只有一个方法可让单一子系统限制或者影响任务。这是合理的：是一个功能，而不是限制。</li>
<li>可以将几个子系统分组在一起以便它们可影响单一层级中的所有任务。因为该层级中的 cgroup 有不同的参数设定，因此会对那些任务产生不同的影响。</li>
<li>有时可能需要重构层级。例如：从附加了几个子系统的层级中删除一个子系统，并将其附加到不同的层级中。</li>
<li>反正，如果从不同层级中分离子系统的需求降低，则可以删除层级并将其子系统附加到现有层级中。</li>
<li>这个设计允许简单的 cgroup 使用，比如为单一层级中的具体任务设定几个参数 ，单一层级可以是只附加了 cpu 和 memory 子系统的层级。</li>
<li>这个设计还允许高精度配置：系统中的每个任务（进程）都可以是每个层级的成员，每个层级都有单一附加的子系统。这样的配置可让系统管理员绝对控制每个单一任务的所有参数。</li>
</ul>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2016/02/25/cgroup_part1/" class="archive-article-date">
  	<time datetime="2016-02-24T16:00:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-02-25</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cgroup/">Cgroup</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-curl_sendmail" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/18/curl_sendmail/">Curl 发送邮件</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>关于curl，大家都知道它可用来访问web页面，下载文件等等。其实它的功能远不止这么点，它支持众多协议，其中就包括发送邮件的SMTP协议。</p>
<h2 id="确认curl是否支持SMTP"><a href="#确认curl是否支持SMTP" class="headerlink" title="确认curl是否支持SMTP"></a>确认curl是否支持SMTP</h2><p>首先确认你的curl是否支持smtp。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># curl-config --protocols |grep SMTP</div></pre></td></tr></table></figure>
<p>如果不支持smtp协议，那么重新安装curl。</p>
<h2 id="安装高版本curl"><a href="#安装高版本curl" class="headerlink" title="安装高版本curl"></a>安装高版本curl</h2><p>使用yum安装的curl一般不支持smtp协议，接下来我们使用源码包来安装。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># cd /usr/local/src</div><div class="line"># wget https://github.com/bagder/curl/archivemaster.zip</div><div class="line"># unzip master.zip</div><div class="line"># cd curl-master</div><div class="line"># ./buildconf</div><div class="line"># ./configure </div><div class="line"># make &amp;&amp; make install</div></pre></td></tr></table></figure>
<p>安装好后再次确认是否支持smtp。</p>
<h2 id="使用curl发送邮件"><a href="#使用curl发送邮件" class="headerlink" title="使用curl发送邮件"></a>使用curl发送邮件</h2><h4 id="编写邮件内容"><a href="#编写邮件内容" class="headerlink" title="编写邮件内容"></a>编写邮件内容</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># cat mail.txt</div><div class="line">From:from@xxx.com</div><div class="line">To:to@xxx.com</div><div class="line">Subject: curl发送邮件标题</div><div class="line"></div><div class="line">邮件内容。。。</div></pre></td></tr></table></figure>
<h4 id="发送邮件"><a href="#发送邮件" class="headerlink" title="发送邮件"></a>发送邮件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># /usr/local/bin/curl -s --url &quot;smtp://smtp.xxx.com --mail-from &quot;from@xxx.com&quot; --mail-rcpt &quot;to@xxx.com&quot; --upload-file mail.txt --user &quot;from@xxx.com:PASSWORD&quot;</div></pre></td></tr></table></figure>
<h4 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h4><blockquote>
<p>–url:            smtp地址</p>
<p>–mail-from:    发件人邮箱</p>
<p>–mail-rcpt:    收件人邮箱</p>
<p>–upload-file:    信件内容，包含发件人、收件人、标题、内容</p>
<p>–user:            账号密码，中间用冒号分割</p>
</blockquote>
<h4 id="curl更多协议"><a href="#curl更多协议" class="headerlink" title="curl更多协议"></a>curl更多协议</h4><p>curl支持众多协议，详细内容可使用如下命令查看。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># /usr/local/bin/curl-config --protocols</div></pre></td></tr></table></figure>
<h2 id="zabbix-curl发邮件脚本"><a href="#zabbix-curl发邮件脚本" class="headerlink" title="zabbix curl发邮件脚本"></a>zabbix curl发邮件脚本</h2><p>我们通常使用<code>sendEmail</code>来发送告警，下面分享一个zabbix使用curl发送告警邮件的脚本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"># -------------------------------------------------------------------------------</div><div class="line"># FileName:    zabbix_curl_sendmail.sh</div><div class="line"># Revision:    1.0</div><div class="line"># Date:        2016/02/18</div><div class="line"># Author:      dingmingk</div><div class="line"># Email:       dingmingk@gmail.com</div><div class="line"># Website:     www.dingmingk.com</div><div class="line"># Description: use curl send email</div><div class="line"># Notes:       ~</div><div class="line"># -------------------------------------------------------------------------------</div><div class="line"># Copyright:   2015 (c) dingmingk</div><div class="line"># License:     GPL</div><div class="line"> </div><div class="line">MAIL_FROM=&apos;from@xxx.com&apos;</div><div class="line">MAIL_TO=$1</div><div class="line">MAIL_SUBJECT=$2</div><div class="line">MAIL_CONTENT=$3</div><div class="line">MAIL_CONTENT_FILE=&quot;/tmp/`/bin/date +%s`.txt&quot;</div><div class="line">MAIL_SMTP=&apos;smtp://smtp.xxx.com&apos;</div><div class="line">MAIL_USER=&apos;from@xxx.com&apos;</div><div class="line">MAIL_PASSWORD=&apos;PASSWORD&apos;</div><div class="line"> </div><div class="line"># create mail content file</div><div class="line">echo &quot;From:$&#123;MAIL_FROM&#125;</div><div class="line">To:$1</div><div class="line">Subject: $MAIL_SUBJECT</div><div class="line"> </div><div class="line">$MAIL_CONTENT &quot;&gt; $&#123;MAIL_CONTENT_FILE&#125;</div><div class="line"> </div><div class="line"># send mail</div><div class="line">/usr/local/bin/curl -s --url &quot;$&#123;MAIL_SMTP&#125;&quot; --mail-from &quot;$&#123;MAIL_FROM&#125;&quot; --mail-rcpt $&#123;MAIL_TO&#125; --upload-file $&#123;MAIL_CONTENT_FILE&#125; --user &quot;$&#123;MAIL_USER&#125;:$&#123;MAIL_PASSWORD&#125;&quot; </div><div class="line"> </div><div class="line"># delete mail content file</div><div class="line">rm $&#123;MAIL_CONTENT_FILE&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2016/02/18/curl_sendmail/" class="archive-article-date">
  	<time datetime="2016-02-17T16:00:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-02-18</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-git_part3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/24/git_part3/">Git 和声</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="冲突解决"><a href="#冲突解决" class="headerlink" title="冲突解决"></a>冲突解决</h2><p>只要有合并就可能会有冲突。</p>
<h3 id="自动合并"><a href="#自动合并" class="headerlink" title="自动合并"></a>自动合并</h3><h4 id="修改不同的文件"><a href="#修改不同的文件" class="headerlink" title="修改不同的文件"></a>修改不同的文件</h4><p>有时候我们在push代码到远程仓库时，会遇到一些小麻烦。</p>
<p><img src="/assets/blogImg/git_part3_1.png" alt="git_part3_1.png"></p>
<p>图为出现非快进式推送时的日志。</p>
<p>这时我们查看当前版本库和远程版本库的commit哈希值，可以发现二者的不同，即出现了非快进式推送。</p>
<p><img src="/assets/blogImg/git_part3_2.png" alt="git_part3_2.png"></p>
<blockquote>
<p><strong>非快进式推送（nor-fast-forwardupdates）</strong> 在远程版本库和当前版本库内容不一致时推送所致，引起原因一般为在多成员协同工作下，其他用户在当前用户版本库上次commit和本次commit之间向远程版本库执行了推送所致。</p>
</blockquote>
<p><strong>解决方法</strong></p>
<ul>
<li>先执行pull，再继续push，即合并后推送。这才是多成员协同工作推荐的方式。</li>
<li>使用 <code>git push origin master --force</code>强制推送。这种方式存在覆盖掉其他人提交的危险，不推荐使用。</li>
</ul>
<h4 id="修改相同文件的不同区域"><a href="#修改相同文件的不同区域" class="headerlink" title="修改相同文件的不同区域"></a>修改相同文件的不同区域</h4><p>解决方法基本如上。但是如果追溯一下文件每一行的来源，可以看到分别是 dingmingk 和 root 用户更改的第一和最后的一行。</p>
<p><img src="/assets/blogImg/git_part3_3.png" alt="git_part3_3.png"></p>
<h4 id="同时更改文件名和文件内容"><a href="#同时更改文件名和文件内容" class="headerlink" title="同时更改文件名和文件内容"></a>同时更改文件名和文件内容</h4><p>解决方法如上。最新版本的文件名和内容都为修改后。</p>
<h3 id="冲突解决-1"><a href="#冲突解决-1" class="headerlink" title="冲突解决"></a>冲突解决</h3><p>如果两个用户修改了同一文件的同一区域，则在合并的时候会遇到冲突而导致合并过程中端。这是因为 Git 并不能越俎代庖地替用户做出决定，而是把决定权交给用户。在这种情况下，Git 标识出合并冲突，等待用户对冲突做出抉择。</p>
<p><img src="/assets/blogImg/git_part3_4.png" alt="git_part3_4.png"></p>
<p>如图所示，特殊标识 &lt;&lt;&lt;&lt;&lt;&lt;&lt;（七个小于号）和 =======（七个等号）之间的内容是当前分支所更改的内容。特殊标识 =======（七个等号）和 &gt;&gt;&gt;&gt;&gt;&gt;&gt;（七个大于号）之间的内容是所合并的版本更改内容。</p>
<p>冲突解决的实质就是通过编辑操作，将冲突标识符所标识的冲突内容替换为合适的内容，并去掉冲突标识符。编辑完后再重新提交即可。</p>
<h2 id="里程碑"><a href="#里程碑" class="headerlink" title="里程碑"></a>里程碑</h2><p>里程碑即 Tag，是人为对提交进行的命名。相比于 Git 默认的提交ID，使用一个直观的表意的字符串会方便得多。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">git tag				&lt;tagname&gt; [&lt;commit&gt;]</div><div class="line">git tag -a			&lt;tagname&gt; [&lt;commit&gt;]</div><div class="line">git tag -m &lt;msg&gt;	&lt;tagname&gt; [&lt;commit&gt;]</div><div class="line">git tag -s			&lt;tagname&gt; [&lt;commit&gt;]</div><div class="line">git tag -u &lt;key-id&gt; &lt;tagname&gt; [&lt;commit&gt;]</div></pre></td></tr></table></figure>
<ul>
<li>第一种是创建轻量级里程碑。</li>
<li>第二种和第三种想同，都是创建带说明的里程碑。其中第三种直接通过 -m 参数提供里程碑创建说明。</li>
<li>第四种和第五种相同，都是创建带 GNUPG 签名的里程碑。其中第五种用 -u 参数选择指定的私钥进行签名。</li>
<li>创建里程碑需要输入里程碑的名字（<tagname>）和一个可选的提交ID（<commit>）。如果没有提供提交ID，则基于头指针 HEAD 创建里程碑。</commit></tagname></li>
</ul>
<h3 id="轻量级里程碑"><a href="#轻量级里程碑" class="headerlink" title="轻量级里程碑"></a>轻量级里程碑</h3><h3 id="带说明的里程碑"><a href="#带说明的里程碑" class="headerlink" title="带说明的里程碑"></a>带说明的里程碑</h3><h3 id="带签名的里程碑"><a href="#带签名的里程碑" class="headerlink" title="带签名的里程碑"></a>带签名的里程碑</h3><h3 id="删除里程碑"><a href="#删除里程碑" class="headerlink" title="删除里程碑"></a>删除里程碑</h3><h3 id="里程碑命名规范"><a href="#里程碑命名规范" class="headerlink" title="里程碑命名规范"></a>里程碑命名规范</h3><h2 id="Git-分支"><a href="#Git-分支" class="headerlink" title="Git 分支"></a>Git 分支</h2><h3 id="分支命令"><a href="#分支命令" class="headerlink" title="分支命令"></a>分支命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">git branch</div><div class="line">git branch &lt;branchname&gt;</div><div class="line">git branch &lt;branchname&gt; &lt;start-point&gt;</div><div class="line">git branch -d &lt;branchname&gt;</div><div class="line">git branch -D &lt;branchname&gt;</div><div class="line">git branch -m &lt;oldbranch&gt; &lt;branchname&gt;</div><div class="line">git branch -M &lt;oldbranch&gt; &lt;newbranch&gt;</div></pre></td></tr></table></figure>
<ul>
<li>第一种用于显示本地分支列表。当前分支在输出中会显示为特别的颜色，并用星号“*”标识出来。</li>
<li>第二种和第三种用于创建分支。用法2基于当前头指针（HEAD）指向的提价创建分支，新分支的分支名 <branchname>。第三种基于提交 <start-point> 创建新分支，新分支的分支名为 <branchname>。</branchname></start-point></branchname></li>
<li>第四种和第五种用户删除分支。第四种在删除分支 <branchname> 时会检查所要删除的分支是否已经合并到其它分支种，否则拒绝删除。第五种会强制删除分支。</branchname></li>
<li>第六种和第七种用于重命名分支。如果版本库中已经存在名为 <newbranch> 的分支，第六种会拒绝执行重命名，而第七种会强制执行。</newbranch></li>
</ul>
<h3 id="分支变基"><a href="#分支变基" class="headerlink" title="分支变基"></a>分支变基</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git checkout develop</div><div class="line">$ git rebase master</div></pre></td></tr></table></figure>
<p>这两条命令会把你的 develop 分支里的每个提交（commit）取消掉，并且把它们临时保存为补丁（这些patch放到 .git/rebase 目录中），然后把 develop 分支更新为最新的 master 分支，最后把保存的这些补丁应用到 develop 分支上。</p>
<h2 id="远程版本库"><a href="#远程版本库" class="headerlink" title="远程版本库"></a>远程版本库</h2><h2 id="代码回滚"><a href="#代码回滚" class="headerlink" title="代码回滚"></a>代码回滚</h2><h3 id="本地代码库回滚"><a href="#本地代码库回滚" class="headerlink" title="本地代码库回滚"></a>本地代码库回滚</h3><p>git reset 命令回滚有三种方式：</p>
<ul>
<li>mixed: 默认方式。它回退到某个版本，只保留源码，回退commit和index信息。</li>
<li>soft: 只回退commit信息，不会恢复index file一级。</li>
<li>hard: 彻底回退到某个版本，本地的源码也会变为上一个版本的内容。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">* $ git reset --[hard|soft|mixed] &lt;commit&gt;	回滚所有内容到某个提交</div><div class="line">* $ git reset --[hard|soft|mixed] HEAD^		回滚所有内容到上一个版本</div><div class="line">* $ git reset --[hard|soft|mixed] HEAD^^ xxx	回滚xxx这个文件到上两个版本</div><div class="line">* $ git reset --[hard|soft|mixed] HEAD~3	回滚所有内容到第三个版本</div><div class="line">* $ git reset --[hard|soft|mixed] origin/master	回滚到和远程一样</div></pre></td></tr></table></figure>
<h3 id="远程代码库回滚"><a href="#远程代码库回滚" class="headerlink" title="远程代码库回滚"></a>远程代码库回滚</h3><p>远程代码库回滚比本地回滚要复杂一些，建议操作前先备份分支。</p>
<p>操作步骤：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">1. $ git checkout &lt;branch&gt;			切换到分支</div><div class="line">2. $ git pull							拉取最新代码</div><div class="line">3. $ git branch &lt;branch&gt; &lt;branch_backup&gt;	备份分支</div><div class="line">4. $ git reset --hard &lt;commit&gt;	回滚本地代码库</div><div class="line">5. $ git push origin :&lt;branch&gt;	删除远程分支</div><div class="line">6. $ git push origin &lt;branch&gt;		将本地分支推送到远程</div><div class="line">7. $ git push origin :&lt;branch_backup&gt;	删除远程备份分支</div></pre></td></tr></table></figure>
<h3 id="反转提交"><a href="#反转提交" class="headerlink" title="反转提交"></a>反转提交</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">* $ git revert &lt;commit&gt;				用一次新的反转提交来消除一个历史提交所做的任何修改</div><div class="line">$ git revert -m 1 &lt;commit&gt;			“-m 1”参数表示某次历史提交的父提交</div></pre></td></tr></table></figure>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2015/12/24/git_part3/" class="archive-article-date">
  	<time datetime="2015-12-23T16:00:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2015-12-24</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Git/">Git</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-saltUser" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/11/saltUser/">SaltStack 用户管理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>SaltStack</code>拥有非常多的模块，功能很强大。其中<code>salt.states.user</code>这个模块可以帮助我们更方便管理服务器用户权限。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">root:</div><div class="line">  user.present:</div><div class="line">    - shell: /bin/bash</div><div class="line">    - passwd: &apos;xxxxxxxxxxxxxxxxxxx&apos;</div><div class="line">    - uid: 0</div><div class="line">    - gid: 0</div><div class="line">    - require:</div><div class="line">      - group: root</div><div class="line">  group.present:</div><div class="line">    - gid: 0</div><div class="line">    </div><div class="line">admin:</div><div class="line">  user.absent</div><div class="line">  </div><div class="line">/root/.ssh/authorized_keys:</div><div class="line">  file.managed:</div><div class="line">    - source: salt://files/.ssh/root_authorized_keys</div><div class="line">    - user: root</div><div class="line">    - group: root</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ openssl passwd -1 -salt &apos;root&apos;</div><div class="line">Password:</div></pre></td></tr></table></figure>
<p>输入密码后会生成一串md5值，替换上面配置文件中的xxx。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ salt &apos;target&apos; state.sls user.sls</div></pre></td></tr></table></figure>
<p>推送到客户端生效。</p>
<p>另外Salt有专门的模块来管理SSH证书，这里先用文件管理的土办法。<em>TODO</em></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2015/12/11/saltUser/" class="archive-article-date">
  	<time datetime="2015-12-10T16:00:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2015-12-11</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SaltStack/">SaltStack</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-nginxAuth" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/09/nginxAuth/">Nginx 简单用户认证</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>有时候我们会有一些Web系统，默认不带登录认证功能，除了限制访问IP之外，还需要添加一个登录认证，Nginx自带的 <code>ngx_http_auth_basic_module</code>模块可以帮我们实现一个简单的用户登录验证功能。</p>
<blockquote>
<p>语法: auth_basic string | off;</p>
<p>默认值: off</p>
<p>配置段: http, server, location, limit_except</p>
</blockquote>
<p>默认不开启认证，如果后面跟上字符，这些字符会在弹窗中显示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ echo -n &apos;dingmingk:&apos; &gt;&gt; conf/site_pass</div><div class="line">$ openssl passwd passwd123 &gt;&gt; conf/site_pass</div></pre></td></tr></table></figure>
<p>生成一个用户名为dingmingk密码为passwd123的用户认证。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">		server_name www.dingmingk.com</div><div class="line">		</div><div class="line">		index index.html index.php;</div><div class="line">		root /data/www.dingmingk.com;</div><div class="line">		</div><div class="line">		location / &#123;</div><div class="line">				auth_basic &quot;Please input your Username&amp;Password.&quot;;</div><div class="line">				auth_basic_user_file conf/site_pass;</div><div class="line">		&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Safari浏览器打开如下：<br><img src="/assets/blogImg/nginxAuth1.png" alt="nginxAuth1"><br>认证错误界面：<br><img src="/assets/blogImg/nginxAuth2.png" alt="nginxAuth2"></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2015/12/09/nginxAuth/" class="archive-article-date">
  	<time datetime="2015-12-08T16:00:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2015-12-09</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-nginxmap" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/04/nginxmap/">Nginx map 使用方法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>map</code>指令是<code>ngx_http_map_module</code>模块提供的，默认情况下nginx有加载这个模块，除非手动<code>--without-http_map_module</code>。</p>
<p><code>ngx_http_map_module</code>模块可以创建变量，这些变量的值与另外的变量值相关联。允许分类或者同时映射多个值到多个不同值并储存到一个变量中，map指令用来创建变量，但是仅在变量被接受的时候执行视图映射操作，对于处理没有引用变量的请求时，这个模块并没有性能上的缺失。</p>
<blockquote>
<p>语法: map $var1 $var2 {…}</p>
<p>默认值: -</p>
<p>配置段: http</p>
</blockquote>
<p>map为一个变量设置的映射表。映射表由两列组成，匹配模式和对应的值。</p>
<p>在map块里的参数指定了源变量值和结果值的对应关系。</p>
<p>匹配模式可以是一个简单的字符串或者正则表达式，使用正则表达式要用(‘~’)。</p>
<p>一个正则表达式如果以“~”开头，表示这个正则表达式对大小写敏感。以“~*”开头，表示这个正则表达式对大小写不敏感。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">map $http_user_agent $agent &#123;</div><div class="line">		default &quot;&quot;;</div><div class="line">		~curl curl;</div><div class="line">		~*apachebench&quot; ab;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>正则表达式里可以包含命名捕获和位置捕获，这些变量可以跟结果变量一起被其它指令使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">map $uri $value &#123;</div><div class="line">		/dingmingk_com						/index.php;</div><div class="line">		~^/dingmingk_com/(?&lt;suffix&gt;.*)$	/boy/;</div><div class="line">		~/fz(/.*)								/index.php?;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>不能在map块里面引用命名捕获或位置捕获变量</strong><br><code>~^/dingmingk_com/(.*) /boy/$1;</code> 这样会报错`nginx:[emerg] unknown variable。</p>
<p>如果源变量值包含特殊字符如’~’，则要以’\’来转义。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">map $http_referer $value &#123;</div><div class="line">	Mozilla	111;</div><div class="line">	\~Mozilla	222;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果变量可以是一个字符串也可以是另外一个变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">map $num $limit &#123;</div><div class="line">	1 $binary_remote_addr;</div><div class="line">	0 &quot;&quot;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>map指令有三个参数:</p>
<ul>
<li>default: 没有匹配结果将使用的默认值。如果没有设置default，将会用一个空的字符串作为默认的结果。</li>
<li>hostnames: 允许用前缀或者后缀掩码指定域名作为源变量值，这个参数必须写在映射列表的最前面。</li>
<li>include: 包含一个或多个含有映射值的文件。</li>
</ul>
<p>如果匹配到多个特定的变量，如掩码和正则同时匹配，那么会按照下面的顺序进行选择：</p>
<ol>
<li>没有掩码的字符串</li>
<li>最长的带前缀的字符串，如“*.example.com”</li>
<li>最长的带后缀的字符串，如“mail.*”</li>
<li>按顺序第一个先匹配的正则表达式（在配置文件中体现的顺序）</li>
<li>默认值</li>
</ol>
<blockquote>
<p>语法: <code>map_hash_bucket_size size;</code></p>
<p>默认值: 32,64,128</p>
<p>配置段: http</p>
</blockquote>
<p>指定一个映射表中的变量在哈希表中的最大值，这个值取决于处理器的缓存。</p>
<blockquote>
<p>语法: <code>map_hash_max_size size;</code></p>
<p>默认值: 2048</p>
<p>配置段: http</p>
</blockquote>
<p>设置映射表对应的哈希表的最大值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">  map $http_user_agent $agent &#123;</div><div class="line">  		~curl curl;</div><div class="line">  		~*chrome chrome;</div><div class="line">  &#125;</div><div class="line">  server &#123;</div><div class="line">  		listen			80;</div><div class="line">  		server_name	test.dingmingk.com;</div><div class="line">  		</div><div class="line">  		location /hello &#123;</div><div class="line">  				default_type text/plain;</div><div class="line">  				echo http_user_agent: $http_user_agent;</div><div class="line">  				echo agent: agent:$agent;</div><div class="line">  		&#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">  map $uri $match &#123;</div><div class="line">  			~^/hello/(.*) http://www.dingmingk.com/;</div><div class="line">  &#125;</div><div class="line">  server &#123;</div><div class="line">  			listen 			80;</div><div class="line">  			server_name 		test.dingmingk.com;</div><div class="line">  			</div><div class="line">  			location /hello &#123;</div><div class="line">  					default_type text/plain;</div><div class="line">  					echo uri: $uri;</div><div class="line">  					echo match: $match;</div><div class="line">  					echo capture: $1;</div><div class="line">  					echo new: $match$1;</div><div class="line">  			&#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2015/12/04/nginxmap/" class="archive-article-date">
  	<time datetime="2015-12-03T16:00:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2015-12-04</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Fleet/">Fleet</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-nginxgeo" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/04/nginxgeo/">Nginx geo 使用方法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>geo</code>指令是<code>ngx_http_geo_module</code>模块提供的，默认情况下nginx有加载这个模块，除非手动<code>--without-http_geo_module</code>。</p>
<p><code>ngx_http_geo_module</code>模块可以用来创建变量，其值依赖于客户端IP地址。</p>
<blockquote>
<p>语法: geo [$address] $variable {…}</p>
<p>默认值: -</p>
<p>配置段: http</p>
</blockquote>
<p>定义从指定的变量获取客户端的IP地址。默认情况下，nginx从<code>$remote_addr</code>变量取得客户端IP地址，但也可以从其它变量获得。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">geo $remote_addr $geo &#123;</div><div class="line">	default 0;</div><div class="line">	127.0.0.1 1;</div><div class="line">&#125;</div><div class="line">geo $arg_dingmingk_com $geo &#123;</div><div class="line">	default 0;</div><div class="line">	127.0.0.1 1;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果该变量的值不能代表一个合法的IP地址，那么nginx将使用地址“255.255.255.255”。</p>
<p>nginx通过CIDR或者地址段来描述地址，支持以下几个参数：</p>
<ul>
<li>delete: 删除指定的网络。</li>
<li>default: 如果客户端地址不能匹配任意一个定义的地址，nginx将使用此值。如果使用CIDR，可以用“0.0.0.0/0”代替default。</li>
<li>include: 包含一个定义地址和值的文件，可以包含多个。</li>
<li>proxy: 定义可信地址。如果请求来自可信地址，nginx将使用其“X-Forwarded-For”头来获得地址。相对于普通地址，可信地址是顺序检测的。</li>
<li>proxy_recursive: 开启递归查找地址。如果关闭递归查找，在客户端地址与某个可信地址匹配时，nginx将使用“X-Forwarded-For”中的最后一个地址来代替原始客户端地址。如果开启递归查找，在客户端地址与某个可信地址匹配时，nginx将使用“X-Forwarded-For”中最后一个与所有可信地址都不匹配的地址来代替原始客户端地址。</li>
<li>ranges: 使用以地址段的形式定义地址，这个参数必须放在首位。为了加速装载地址库，地址应按升序定义。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">geo $country &#123;</div><div class="line">	default			ZZ;</div><div class="line">	include			conf/geo.conf;</div><div class="line">	delete 			127.0.0.0/16;</div><div class="line">	proxy				192.168.100.0/24;</div><div class="line">	proxy				2001:0db8::/32;</div><div class="line">	</div><div class="line">	127.0.0.0/24		US;</div><div class="line">	127.0.0.1/32		RU;</div><div class="line">	10.1.0.0/16		RU;</div><div class="line">	192.168.1.0/24	UK;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$vim conf/geo.conf</div><div class="line"></div><div class="line">10.2.0.0/16			RU;</div><div class="line">192.168.2.0/24		RU;</div></pre></td></tr></table></figure>
<p>地址段例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">geo $country &#123;</div><div class="line">	ranges;</div><div class="line">	default						ZZ;</div><div class="line">	127.0.0.0-127.0.0.0			US;</div><div class="line">	127.0.0.1-127.0.0.1			RU;</div><div class="line">	127.0.0.1-127.0.0.255		US;</div><div class="line">	10.1.0.0-10.1.255.255		RU;</div><div class="line">	192.168.1.0-192.168.1.255	UK;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>遵循最精确匹配原则，即nginx使用能最精确匹配客户端地址的值。</strong></p>
<p>下面看几个适用实例以便理解该指令的用法。</p>
<p>1.使用默认变量也就是<code>$remote_addr</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">  #geo $remote_addr $dingmingk_com &#123;</div><div class="line">  geo $dingmingk_com &#123;</div><div class="line">  			default 0;</div><div class="line">  			127.0.0.1 1;</div><div class="line">  &#125;</div><div class="line">  server &#123;</div><div class="line">  			listen			80;</div><div class="line">  			server_name	test.dingmingk.com;</div><div class="line">  			</div><div class="line">  			location /hello &#123;</div><div class="line">  					default_type		text/plan;</div><div class="line">  					echo 				$dingmingk_com;					echo				$arg_boy;</div><div class="line">  			&#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ curl 127.0.0.1/helo?boy=king</div><div class="line">1</div><div class="line">king</div></pre></td></tr></table></figure>
<p>2.使用指定变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">  geo $arg_boy $dingmingk_com &#123;</div><div class="line">  			default 0;</div><div class="line">  			127.0.0.1 1;</div><div class="line">  			8.8.8.8 2;</div><div class="line">  &#125;</div><div class="line">  server &#123;</div><div class="line">  			listen				80;</div><div class="line">  			server_name		test.dingmingk.com;</div><div class="line">  			</div><div class="line">  			location /hello &#123;</div><div class="line">  					default_type text/plain;</div><div class="line">  					echo $dingmingk_com;</div><div class="line">  					echo $arg_boy;</div><div class="line">  			&#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$curl 127.0.0.1/hello?boy=8.8.8.8</div><div class="line">2</div><div class="line">8.8.8.8</div></pre></td></tr></table></figure>
<p>3.匹配原则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">  geo $arg_boy $dingmingk_com &#123;</div><div class="line">  			default 0;</div><div class="line">  			127.0.0.1/24 24;</div><div class="line">  			127.0.0.1/32 32;</div><div class="line">  			8.8.8.8 2;</div><div class="line">  &#125;</div><div class="line">  server &#123;</div><div class="line">  			listen			80;</div><div class="line">  			server_name  test.dingmingk.com;</div><div class="line">  			</div><div class="line">  			location /hello &#123;</div><div class="line">  							default_type text/plain;</div><div class="line">  							echo $dingmingk_com;</div><div class="line">  							echo $arg_boy;</div><div class="line">  			&#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$curl 127.0.0.1/hello?boy=127.0.0.1</div><div class="line">32</div><div class="line">127.0.0.1</div><div class="line">$curl 127.0.0.1/hello?boy=127.0.0.12</div><div class="line">23</div><div class="line">127.0.0.12</div></pre></td></tr></table></figure>
<p><strong>geo指令主要是根据IP来对变量进行赋值的。因此geo模块下只能定义IP或网段，否则会报错“nginx:invalid network。”</strong></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2015/12/04/nginxgeo/" class="archive-article-date">
  	<time datetime="2015-12-03T16:00:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2015-12-04</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
    </nav>
  


      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2019 dingmingk
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true
	}
</script>

<script src="/./main.js"></script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
      <li data-hook="tools-section-friends"><span class="text">友链</span><i class="icon-link"></i></li>
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<a href="/tags/Cgroup/" style="font-size: 12.5px;">Cgroup</a> <a href="/tags/Continuous/" style="font-size: 10px;">Continuous</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Fleet/" style="font-size: 12.5px;">Fleet</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/Jenkins/" style="font-size: 12.5px;">Jenkins</a> <a href="/tags/Kubernetes/" style="font-size: 20px;">Kubernetes</a> <a href="/tags/Life/" style="font-size: 12.5px;">Life</a> <a href="/tags/Linux/" style="font-size: 12.5px;">Linux</a> <a href="/tags/Mac/" style="font-size: 10px;">Mac</a> <a href="/tags/Nginx/" style="font-size: 17.5px;">Nginx</a> <a href="/tags/Pipeline/" style="font-size: 10px;">Pipeline</a> <a href="/tags/RabbitMQ/" style="font-size: 10px;">RabbitMQ</a> <a href="/tags/SaltStack/" style="font-size: 10px;">SaltStack</a> <a href="/tags/Systemd/" style="font-size: 15px;">Systemd</a>
    			</div>
    	</section>
    

    
    	<section class="tools-section tools-section-friends">
  		
  			<div class="friends-wrap" id="js-friends">
  			
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接1</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接2</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接3</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接4</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接5</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">友情链接6</a>
  	        
  	        </div>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">很惭愧&lt;br&gt;&lt;br&gt;只做了一点微小的工作&lt;br&gt;谢谢大家</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>